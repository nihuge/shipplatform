<extend name="Public:base"/>
<block name="title">船舱管理</block>
<block name="navtitle">
    <li class="active">
        船舱管理
    </li>
    <li class="active">
        船舱修改
    </li>
</block>
<block name="active7">class="active"</block>
<block name="content">
    <div class="page-container">
        <form action="__ACTION__" method="post">
            <div style='width:800px;margin:auto auto;'>
                所属船：
                <select style="width: 200px;" name="shipid" required id='shipid'>
                    <option value="">----&nbsp;选&nbsp;择&nbsp;船&nbsp;舶&nbsp;----</option>
                    <volist name="shiplist" id="v">
                        <option value="{$v['id']}" NUMBER="{$v['cabinnum']}" SUANFA="{$v['suanfa']}">{$v['shipname']}
                        </option>
                    </volist>
                </select>
                <span style="margin-left: 40px;color: red;">基准高度支持输入4位整数或小数，并且会检查数据</span>
            </div>
            <br>
            <div>
                <div style="text-align: left;float: left">
                    <div id="errorMsg" style="color: red"></div>
                </div>
                <div style="text-align: right;float: right">

                    <input style="left: 10px;width: 18px;height: 18px;" type="checkbox" id="no_check" name="jizhu" title="勾选时不提示数据" lay-skin="primary"><label for="no_check" style="font-size: 17px;margin-right: 10px;color: #a03e00">勾选时不提示数据</label><span class="layui-btn layui-btn-normal" style="margin-right: 150px;" onclick="match_cabin()">自动识别数据</span>
    <!--                <input type="checkbox" id="no_check" style="border-radius: 50%;width: 16px;height: 16px;"/>-->
                </div>
            </div>
            <table id="sample-table-1" class="table table-striped table-bordered table-hover"
                   style='width:800px;margin:auto auto;text-align: center;'>
                <tr>
                    <td rowspan="2">舱名</td>
                    <td colspan="2">基准高度(H)</td>
                    <td colspan="2">底量(D)</td>
                    <td rowspan="2">管线容量</td>
                </tr>
                <tr>
                    <td>容量表</td>
                    <td>底量表</td>
                    <td>容量表</td>
                    <td>底量表</td>
                </tr>
            </table>
        </form>
    </div>
    <script type="text/javascript">
        var checksign = true;

        //下拉获取cang,单选获取表
        $("select[name=shipid]").change(function () {
            var edc = $("#sample-table-1");
            var string = '<tr><td rowspan="2">舱名</td><td colspan="2">基准高度(H)</td><td colspan="2">底量(D)</td><td rowspan="2">管线容量</td></tr><tr><td>容量表</td><td>底量表</td><td>容量表</td><td>底量表</td></tr>';
            if ($(this).children().is(':selected')) {
                var id = $(this).val();

                if (id !== '') {
                    var num = $('#shipid option:selected').attr('NUMBER');
                    let suanfa = $('#shipid option:selected').attr('SUANFA');
                    console.log(num);
                    if (suanfa == 'c' || suanfa == 'd') {
                        for (var i = 1; i <= num; i++) {
                            // pipe_line
                            string += '<tr><td><input type="text" id="form-field-1" class="col-xs-15 col-sm-12" required value="" name="data[' + i + '][cabinname]" maxlength="5" tabindex="' + (num * 0 + i) + '"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" required value="" name="data[' + i + '][altitudeheight]" maxlength="5" tabindex="' + (num * 1 + i) + '"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" value="" name="data[' + i + '][dialtitudeheight]" maxlength="5" tabindex="' + (num * 2 + i) + '"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" required value="" name="data[' + i + '][bottom_volume]" maxlength="5" tabindex="' + (num * 3 + i) + '"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" value="" name="data[' + i + '][bottom_volume_di]" maxlength="5" tabindex="' + (num * 4 + i) + '"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" required value="" name="data[' + i + '][pipe_line]" maxlength="5" tabindex="' + (num * 5 + i) + '"/></td></tr>';
                        }
                    } else {
                        for (var i = 1; i <= num; i++) {
                            // pipe_line
                            string += '<tr><td><input type="text" id="form-field-1" class="col-xs-15 col-sm-12" required value="" name="data[' + i + '][cabinname]" maxlength="5" tabindex="' + (num * 0 + i) + '"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" required value="" name="data[' + i + '][altitudeheight]" maxlength="5" tabindex="' + (num * 1 + i) + '"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" value="" name="data[' + i + '][dialtitudeheight]" maxlength="5" tabindex="' + (num * 2 + i) + '" disabled="disabled"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" required value="" name="data[' + i + '][bottom_volume]" maxlength="5" tabindex="' + (num * 3 + i) + '"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" value="" name="data[' + i + '][bottom_volume_di]" maxlength="5" tabindex="' + (num * 4 + i) + '" disabled="disabled"/></td><td><input type="text" id="form-field-2" class="col-xs-15 col-sm-12" required value="" name="data[' + i + '][pipe_line]" maxlength="5" tabindex="' + (num * 5 + i) + '"/></td></tr>';
                        }
                    }
                    string += '<tr><td colspan=6 style="text-align: center;"><input type="submit" name="sub" value="提交" class="btn btn-primary" ></td></tr>';
                }
                edc.html(string);

            } else {
                edc.html(string);
            }

            // var hasFocus = $('input[type=text]').is(':focus');

            var inputs = $('input[id=form-field-2]');
            // console.log(inputs.val());

            inputs.on("blur", function () {
                var tmptxt = $(this).val();
                if (tmptxt !== "") {
                    if (tmptxt.indexOf(".") == -1) {
                        var number = parseInt(tmptxt);
                        if (number >= 1000) {
                            $(this).val(number / 1000);
                        } else {
                            if (checksign) {
                                layer.tips('此数值有些问题，请检查', $(this), {
                                    tips: [2, '#3595CC'],
                                    time: 4000,
                                    tipsMore:true
                                });
                            }
                        }
                    }
                }
                // alert("整数");
            });
        });

        $('#no_check').change(function () {
            var choice = $(this)[0].checked;

            if (choice === false) {
                checksign = true;
            } else {
                checksign = false;
            }

            console.log(checksign);
        });

        function match_cabin() {
            let shipid = $("select[name=shipid]").val();
            let cabinnum = $('#shipid option:selected').attr('NUMBER');

            if( shipid!=="" ){
                let suanfa = $('#shipid option:selected').attr('SUANFA');
                let errorMsg = $('#errorMsg');

                let content = '';
                content += '<form class="layui-form" method="post"><input type="hidden" name="shipid" value="'+shipid+'">';

                content +='<div class="layui-form-item">\n' +
                    '    <label class="layui-form-label">是否有底量栏</label>\n' +
                    '    <div class="layui-input-block">\n' +
                    '      <input type="radio" name="has_diliang" value="1" title="有" checked="">\n' +
                    '      <input type="radio" name="has_diliang" value="2" title="无">\n' +
                    '    </div>\n' +
                    '  </div>\n' +
                    '  <div class="layui-form-item layui-form-text">\n' +
                    '    <label class="layui-form-label">容量书</label>\n' +
                    '    <div class="layui-input-block">\n' +
                    '      <textarea placeholder="请输入内容" class="layui-textarea" name="rong_txt"></textarea>\n' +
                    '    </div>\n' +
                    '  </div>';
                if (suanfa == 'c' || suanfa == 'd') {
                    content +='  <div class="layui-form-item layui-form-text">\n' +
                    '    <label class="layui-form-label">底量书</label>\n' +
                    '    <div class="layui-input-block">\n' +
                    '      <textarea placeholder="请输入内容" class="layui-textarea" name="di_txt"></textarea>\n' +
                    '    </div>\n' +
                    '  </div>';
                }

                content += '<div class="layui-form-item">\n' +
                    '    <div class="layui-input-block">\n' +
                    '      <button type="submit" class="layui-btn" lay-submit="" lay-filter="demo1">立即提交</button>\n' +
                    '    </div>\n' +
                    '  </div>';
                content += '</form>';

                let index = layer.open({
                    type: 1,
                    title:"识别书内舱信息",
                    skin: 'layui-layer-rim', //加上边框
                    area: ['650px', '450px'], //宽高
                    content: content
                });
                layui.use('form', function(){
                    var form = layui.form;
                    form.render();
                    form.on('submit(demo1)', function(data){
                        $.ajax({
                            url: "{:U('Cabin/match_cabin')}",
                            type: "POST",
                            data: data.field,
                            dataType: "json",
                            success: function (data) {
                                if (data.state == 1) {
                                    let edc = $("#sample-table-1");
                                    edc.html(data.content);
                                    console.log(data.cabinnum,cabinnum);
                                    if(data.cabinnum != cabinnum){
                                        layer.alert("船舶资料的舱数与书内的舱数不符合，请检查", {
                                            icon: 5
                                        });
                                    }
                                    layer.close(index);
                                } else {
                                    layer.alert(data.error, {
                                        icon: 5
                                    });
                                }
                            }
                        });
                        return false;
                    })
                });
            }else {
                layer.alert('请选择船');
            }

        }

    </script>
</block>