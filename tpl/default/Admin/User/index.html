<extend name="Public:base"/>
<block name="header_require">
<!--        <link rel="stylesheet" href="__PUBLIC__/bootstrapBox/css/bootstrap.css" type="text/css"/>-->
            <link rel="stylesheet" href="__PUBLIC__/bootstrapBox/css/awesome-bootstrap-checkbox.css" type="text/css"/>
            <link rel="stylesheet" href="__PUBLIC__/bootstrapBox/Font-Awesome/css/font-awesome.min.css" type="text/css"/>

    <!--    <link rel="stylesheet" href="__PUBLIC__/bootstrapBox/css/default.css" type="text/css"/>-->
</block>
<block name="title">用户管理</block>
<block name="navtitle">
    <li class="active">
        用户管理
    </li>
    <li class="active">
        用户列表
    </li>
</block>
<block name="active5">class="active"</block>
<block name="content">
    <div class="page-container">
        <div>
            <form action="__ACTION__" method="get">
                <input type="hidden" name="c" value="User">
                <input type="hidden" name="a" value="index">
                <select class=" col-xs-10 col-sm-2" id="form-field-select-1" name="firmid">
                    <option value="">选择所属公司</option>
                    <volist name="firmlist" id="v">
                        <option value="{$v['id']}">{$v['firmname']}</option>
                    </volist>
                </select>&nbsp;
                <button class="btn btn-sm btn-primary">查询</button>
            </form>
        </div>
        <h4></h4>
        <table id="sample-table-1" class="table table-striped table-bordered table-hover">
            <thead>
            <tr>
                <th>账号</th>
                <th>用户名</th>
                <th>联系电话</th>
                <th>所属公司</th>
                <th>重置密码</th>
                <th>状态</th>
                <th>操作</th>
            </tr>
            </thead>
            <volist name="data" id="v">
                <tr align='center'>
                    <td align='left'>{$v['_name']}</td>
                    <td>{$v['username']}</td>
                    <td>{$v['phone']}</td>
                    <td>{$v['firmname']}</td>
                    <td><a href="javascript:;" onclick="resetpwd('{$v['id']}')" style="color:red;">重置密码</a></td>
                    <if condition="$v['status'] == 2">
                        <td><a href="javascript:;" onclick="changestatus('{$v['id']}','1')" style="color:red">解除冻结</a>
                        </td>
                        <else/>
                        <td><a href="javascript:;" onclick="changestatus('{$v['id']}','2')" style="color:black">冻结用户</a>
                        </td>
                    </if>
                    <td>
                        <a href="{:U('User/edit',array('firmid'=>$v['firmid'],'id'=>$v['id']))}">修改</a>

                        |&nbsp;
                        <a href="{:U('User/configSearch',array('id'=>$v['id']))}">分配查询权限</a>
                        <!-- 只有公司管理才可以添加操作人员和复制给操作员权限 -->
                        <if condition="$v['pid'] == '0'">
                            |&nbsp;<a href="#" onclick="copyJur({$v['id']})">复制权限到</a>
                            |&nbsp;<a href="{:U('User/add',array('firmid'=>$v['firmid'],'id'=>$v['id']))}">新增操作员</a>
                        </if>
                    </td>
                </tr>
            </volist>
            <tr>
                <td colspan="7" class="pages">{$page}</td>
            </tr>
        </table>
    </div>
    <script>
        //重置密码
        function resetpwd(id) {
            layer.confirm('您确定要重置密码吗？', {
                btn: ['确定', '取消'] //按钮
            }, function () {
                $.ajax({
                    url: "__CONTROLLER__/resetpwd",
                    type: "POST",
                    data: {
                        "id": id
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.state == 1) {
                            //刷新
                            location.reload();
                        } else {
                            layer.msg(data.msg, {
                                icon: 5
                            });
                        }
                    }
                });
            })
        }

        //复制权限
        function copyJur(id) {


            $.ajax({
                url: "{:U('User/copyJur')}/id/" + id,
                type: "GET",
                dataType: "json",
                success: function (data) {
                    var operator = data;
                    if(operator.length == 0){
                        layer.msg("该管理员下并无操作员");
                        return false;
                    }
                    var content = ' <div class="row" style="width: 420px;  margin-left:7px; margin-top:10px;">';
                    for (var k in operator) {
                        content += '<div class="checkbox checkbox-primary" style="margin-left: 60px">'
                            + '<input id="id_' + operator[k]["id"] + '" type="checkbox" name="id" value="' + operator[k]["id"] + '" class="styled">'
                            + '<label for="id_' + operator[k]["id"] + '">'+ operator[k]["username"] + '</label>'
                            + '</div>';
                    }

                    content += '</div>';

                    layer.open({
                        id: 1,
                        type: 1,
                        title: '复制权限',
                        skin: 'layui-layer-rim',
                        area: ['450px', 'auto'],

                        content: content,
                        btn: ['保存', '取消'],
                        btn1: function (index, layero) {
                            var id_array = [];
                            $('input[name="id"]:checked').each(function () {
                                id_array.push($(this).val());//向数组中添加元素
                            });

                            if (id_array.length == 0) {
                                //提示层
                                layer.alert("新密码和确认密码不一致！", {
                                    icon: 5
                                });
                            } else {
                                $.ajax({
                                    url: "{:U('User/copyJur')}/id/" + id,
                                    type: "POST",
                                    data: {
                                        "operator": id_array,
                                    },
                                    dataType: "json",
                                    success: function (data) {
                                        if (data.state == 1) {
                                            layer.alert('修改成功', {icon: 6}, function () {
                                                //刷新
                                                location.reload();
                                            });
                                        } else {
                                            console.log(data);
                                            layer.alert(data.msg, {
                                                icon: 5
                                            });
                                        }
                                    }
                                });
                            }
                        },
                        btn2: function (index, layero) {
                            layer.close(index);
                        }

                    });
                }
            });


            /**/
        }

        //修改状态
        function changestatus(id, status) {
            layer.confirm('您确定要修改状态吗？', {
                btn: ['确定', '取消'] //按钮
            }, function () {
                $.ajax({
                    url: "__CONTROLLER__/changestatus",
                    type: "POST",
                    data: {
                        "id": id,
                        "status": status
                    },
                    dataType: "json",
                    success: function (data) {
                        if (data.state == 1) {
                            //刷新
                            location.reload();
                        } else {
                            layer.msg(data.msg, {
                                icon: 5
                            });
                        }
                    }
                });
            })
        }
    </script>
</block>